# Q&Aカンペ（CaShield）

## 想定Q&A

**Q2. LLMに会話を要約させる際のプロンプトは、どのような工夫をしていますか？**

**A2.** プロンプトでは、単に「要約して」とお願いするだけでなく、いくつかの工夫を加えています。
1.  **役割（ロール）の設定**: `あなたはカスタマーハラスメント対策の監視AIです` と最初に役割を与えることで、LLMの応答のトーンや視点を固定しています。
2.  **構造化出力の強制**: `response_schema`という機能を使って、出力してほしいJSONの形式（`ng_word`, `summary`, `severity`など）を厳密に定義しています。これにより、後続のプログラムで処理しやすい、安定した形式の出力を得られます。
3.  **事実ベースの指示**: `誇張せず、事実ベースで` といった指示を加え、LLMが創作や過度な解釈をせず、あくまでログに基づいた客観的な要約を生成するように促しています。

**Q3. リアルタイム処理とのことですが、遅延（レイテンシ）はどのくらいですか？**

**A3.** システム全体の遅延は、複数の要因によって変動します。
*   **音声入力〜VAD**: `sounddevice`と`webrtc-vad`による処理は非常に高速で、数十ミリ秒単位です。
*   **文字起こし (ASR)**: ここが最も時間がかかる部分で、話された音声の長さに依存します。数秒の発話であれば、Raspberry Pi 4のCPUでも2〜3秒程度でテキストに変換できます。
*   **LLM要約**: これは非同期のバックグラウンド処理なので、リアルタイム性には影響しません。NGワードを検知してから要約が生成されるまでには、通信時間を含めて5〜10秒程度かかります。
利用者が「検知された」と感じるまでの時間（発話してから警告音が鳴るまで）は、**おおよそ3〜5秒**程度となります。

**Q4. NGワードのリストはどのように管理していますか？表記ゆれ（例：「死ね」と「しね」）には対応できますか？**

**A4.** NGワードは `config/keywords.txt` というプレーンテキストファイルで管理しており、1行に1つの単語を記述するだけで簡単に追加・編集できます。
表記ゆれへの対応ですが、システム内部で**文字起こしされたテキストと、キーワードリストの両方を「ひらがな」に変換してから比較**しています。これにより、例えばキーワードに「馬鹿」と登録しておけば、音声認識結果が「バカ」や「ばか」であっても、すべて検知することが可能です。この処理には`pykakasi`というライブラリを利用しています。

**Q6. PyAudioなど他の音声ライブラリもある中で、sounddeviceとwebrtc-vadを特に選んだ理由は何ですか？**

**A6.** 良いご質問ありがとうございます。その2つを選んだのは、**リアルタイム性と効率性**を最大限に高めるためです。
*   **sounddevice**: PyAudioも優れたライブラリですが、`sounddevice`は特に低遅延（ローレイテンシ）な音声ストリーミングに強みがあります。本システムでは`RawInputStream`という機能を使って、OSのバッファを介さず、非常に小さな単位（20-30ミリ秒）で直接マイクから音声データを取得しています。これにより、発話からシステムが反応するまでの時間を極限まで短縮し、リアルタイム性を高めています。
*   **webrtc-vad**: こちらはGoogleが開発した、軽量かつ高性能な音声区間検出（Voice Activity Detection）ライブラリです。人の声がする区間だけを正確に切り出し、無音の部分を処理から除外する役割を担います。これにより、後段の音声認識エンジン（faster-whisper）に無駄なデータを送らずに済み、計算リソースを節約できるだけでなく、認識精度そのものの向上にも繋がります。
この2つを組み合わせることで、「**素早く音声を受け取り、話している部分だけを効率的に処理する**」という、本システムの根幹をなすパイプラインを実現しています。

**Q7. 音声認識やLLMによる要約の“範囲・時間”のセクションはどのようになっていますか？**

**A7.** 2段構えで制御しています。いずれも「コード内設定オブジェクト」で集中管理しており、`.env`は使用しません。
- **音声認識の区間化（VAD前段）**: `src/config/asr.py` の `ASRConfig` にて、フレーム長 `BLOCK_MS=30`、VAD攻撃性 `VAD_AGGRESSIVENESS=2`、および発話検出時の前後パディング `PAD_PREV_MS=200` / `PAD_POST_MS=300` を指定し、無音を除外しつつ発話の頭切れ・末尾欠けを避けています。
- **LLM要約の窓取り**: `src/llm/windowing.py` の `build_window` と、`src/llm/queue.py` の `WindowConfig` により管理します。初期はNGワード行の前後±2発話を取り、そこから最低 `min_sec=12秒` に達するまで前後に拡張します。上限は `max_sec=30秒` と `max_tokens=512` の両方を満たすように端から削減します。基点の時刻は `anchor_time` として保持し、抽出範囲の行インデックスもメタ情報に保存します。
- 変更したい場合は、`ASRConfig` と `WindowConfig` のクラス属性を書き換えるだけで反映されます（再起動時に有効）。
