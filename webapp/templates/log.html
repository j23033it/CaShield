{% extends "base.html" %}

{% block title %}{{ date }} „ÅÆ‰ºöË©±„É≠„Ç∞{% endblock %}

{% block content %}
  <button class="btn btn-outline-secondary mode-btn" id="modeToggle">üåô</button>
  <h1 class="mb-4 fw-bold">{{ date }} „ÅÆ‰ºöË©±„É≠„Ç∞</h1>
  <a href="/" class="btn btn-secondary mb-3">‚Üê Êàª„Çã</a>
  <input type="text" class="form-control search-box" id="searchInput" placeholder="„Ç≠„Éº„ÉØ„Éº„Éâ„ÅßÊ§úÁ¥¢...">
  <div class="chat-container" id="logContainer">
    {% for text, is_ng, role, time in logs %}
      <div class="chat-row {{ role }}">
        {% if role=='customer' %}<img src="{{ url_for('static', filename='customer.png') }}" class="avatar">{% endif %}
        <div class="bubble {{ role }} {% if is_ng %}ng{% endif %}" data-time="{{ time }}">
          <div class="content">{{ text }}</div>
          {% if is_ng %}<div class="small text-muted mt-1 summary-slot"></div>{% endif %}
          <div class="chat-meta">{{ time }}</div>
        </div>
        {% if role=='clerk' %}<img src="{{ url_for('static', filename='clerk.png') }}" class="avatar">{% endif %}
      </div>
    {% endfor %}
  </div>
  <script id="initData" type="application/json">
    {{ logs|tojson }}
  </script>
  <audio id="notifySound" src="{{ url_for('static', filename='notify.mp3') }}" preload="auto"></audio>
{% endblock %}

{% block scripts %}
  <script>
    const modeBtn = document.getElementById("modeToggle");
    if (localStorage.getItem("darkMode") === "true") {
      document.body.classList.add("dark");
      modeBtn.textContent = "‚òÄÔ∏è";
    }
    modeBtn.addEventListener("click", () => {
      document.body.classList.toggle("dark");
      const isDark = document.body.classList.contains("dark");
      localStorage.setItem("darkMode", isDark);
      modeBtn.textContent = isDark ? "‚òÄÔ∏è" : "üåô";
    });

    if ("Notification" in window && Notification.permission !== "granted") {
      Notification.requestPermission();
    }

    const searchInput = document.getElementById("searchInput");
    const container = document.getElementById("logContainer");
    const notifySound = document.getElementById("notifySound");
    const _items = JSON.parse(document.getElementById("initData").textContent)
      .map(([text,is_ng,role,time]) => ({text, is_ng, role, time}));

    function renderFiltered(){
      const keyword = searchInput.value.trim();
      container.innerHTML = "";
      _items.forEach(item => {
        if(keyword && !item.text.includes(keyword)) return;
        appendItem(item, false);
      });
    }

    function appendItem(item, doScroll=true){
      const row = document.createElement("div");
      row.className = `chat-row ${item.role}`;
      const bubble = document.createElement("div");
      bubble.className = `bubble ${item.role} ${item.is_ng ? 'ng' : ''}`;
+     bubble.setAttribute('data-time', item.time || "");
      bubble.innerHTML = `<div class='content'>${item.text}</div>` +
        (item.is_ng ? `<div class='small text-muted mt-1 summary-slot'></div>` : "") +
        `<div class='chat-meta'>${item.time}</div>`;
      if(item.role === 'customer') {
        row.innerHTML = `<img src="{{ url_for('static', filename='customer.png') }}" class='avatar'>`;
        row.appendChild(bubble);
      } else {
        row.appendChild(bubble);
        row.innerHTML += `<img src="{{ url_for('static', filename='clerk.png') }}" class='avatar'>`;
      }
      container.appendChild(row);
      if(doScroll) container.scrollTop = container.scrollHeight;
    }

    searchInput.addEventListener("input", renderFiltered);
    renderFiltered(); // ÂàùÊúüÊèèÁîª„ÇíÊï¥ÁêÜ

    async function refreshSummaries(){
      try{
        const res = await fetch(`/api/summaries/{{date}}`);
        const data = await res.json();
        const items = data.items || [];
        const bubbles = document.querySelectorAll(".bubble.ng");
        items.forEach(s => {
          // anchor_time „Åß„Éû„ÉÉ„ÉÅÔºàÂêåÊôÇÂàª„ÅåË§áÊï∞„ÅÇ„ÇãÂ†¥Âêà„ÅØÊúÄÂàù„ÇíÊé°Áî®Ôºâ
          const t = s.anchor_time || "";
          const target = Array.from(bubbles).find(b => (b.getAttribute("data-time")||"") === t);
          if(target){
            const slot = target.querySelector(".summary-slot");
            if(slot && !slot.dataset.filled){
              slot.dataset.filled = "1";
              slot.innerHTML = `<b>Ë¶ÅÁ¥Ñ</b>Ôºö${s.summary}<br><b>Ê∑±ÂàªÂ∫¶</b>Ôºö${s.severity} / 5<br><b>ÂØæÂøú</b>Ôºö${s.action}`;
            }
          }
        });
      }catch(e){ console.warn("summary fetch failed", e); }
    }
    setInterval(refreshSummaries, 5000);
    refreshSummaries();

    (function connect(){
      const es = new EventSource(`/stream/{{date}}`);
      es.onmessage = (e) => {
        try {
          const data = JSON.parse(e.data);
          // Êú¨Êñá„ÅåÁÑ°„ÅÑÔºèÊôÇÂàª„Å†„Åë„ÅÆË°å„ÅØÁÑ°Ë¶ñÔºà‰øùÈô∫Ôºâ
          if(!data || !data.text || /^\d{4}-\d{2}-\d{2}\s+\d{2}:\d{2}:\d{2}$/.test(data.text)) return;
          _items.push(data);
          const kw = searchInput.value.trim();
          if(!kw || data.text.includes(kw)) {
            appendItem(data);
            // ÈÄöÁü•Èü≥„ÅØ NG Ë°å„Å´ÈôêÂÆö
            if (data.is_ng) {
              notifySound.currentTime = 0;
              notifySound.play();
            }
          }
          if ("Notification" in window && Notification.permission === "granted") {
              // „Éñ„É©„Ç¶„Ç∂ÈÄöÁü•„ÇÇ NG „ÅÆ„ÅøÔºàÈ®í„Åå„Åó„ÅïËªΩÊ∏õÔºâ
              if (data.is_ng) new Notification("NGÊ§úÂá∫", { body: data.text });
          }
        } catch(err){ console.error('SSE parse error', err); }
      };
      es.onerror = () => {
        es.close();
        setTimeout(connect, 3000);
      };
    })();
  </script>
{% endblock %}
